<!DOCTYPE html>
<html>
    <link rel="stylesheet" href="../static/flight.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <body>

        <div id="navbar">
            <a href="http://localhost:8001">home</a>
            <a href="http://localhost:8001/login" class="auth">login</a>
            <a href="http://localhost:8001/register" class="auth">register</a>
            <a href="http://localhost:8001/inventory" class="nav">inventory</a>
            <a href="http://localhost:8001/notifications" class="nav">notifications(<span id="unread"></span>)</a>
            <a href="http://localhost:8001" onclick="logout()" class="nav">logout</a>
        </div>

        <div id="flights-info">
            <div id="flight-info">
                <div class="flight-info-column">Flight: <span id="flight"></span></div>
                <div class="flight-info-column">From: <span id="from"></span></div>
                <div class="flight-info-column">To: <span id="to"></span></div>
                <div class="flight-info-column">Airline: <span id="airline"></span></div>
                <div class="flight-info-column">Date: <span id="date"></span></div>
                <div class="flight-info-column">Time: <span id="time"></span></div>
            </div>
            <ul id="tickets"></ul>
            
        </div>
        <div id="exchange"> Exchange </div>
    </body>

    <script>
    
        const url = window.location.pathname;
        const id = url.split("/")[2];
        const old_id_string = localStorage.getItem('ticket_id_old');
        const old_id = parseInt(old_id_string, 10);
        let new_id_string='' ;
        const exchange_div=document.querySelector('#exchange');
        let tickets = [];
        let filteredTickets = [];
        // exchange_div.style.display='none';
        exchange_div.className='disable';
    // 1. xu ly trang flight cua flow mua ve  
        // hien thi elements tuy thuoc vao trang thai dang nhap
        const username = localStorage.getItem("username");
        const authElements = document.querySelectorAll(".auth");
        const navElements = document.querySelectorAll(".nav");
        if (username != null) {
            authElements.forEach(item => item.style.display = "none");
            navElements.forEach(item => item.style.display = "flex");
        }
        else {
            authElements.forEach(item => item.style.display = "flex");
            navElements.forEach(item => item.style.display = "none");
        }

        // xoa data nguoi dung duoc luu trong ls
        function logout() {
            localStorage.clear();
        }
        //function ownOldToNew
        function ownOldToNew(){
            const username = localStorage.getItem("username");
            if (username == null) {
                window.location = "http://localhost:8001/login";
                return;
            }
            let number ;
            let expirationDate ;
            let securityCode ;
            let fullName ;

            fetch(`/own/${id}`, {
                method: "GET",
            })
            .then(response => {
                return(response.text());
            })
            .then(data => {
                const ticket = JSON.parse(data)
                console.log(ticket);
            });
                
                // console.log(`number: ${number}\nexpirationDate: ${expirationDate},\nsecurityCode: ${securityCode}\nfullName: ${fullName}`);
                
                // const requestOptionsOwn = {
                //     method: "POST",
                //     headers: {
                //         "Content-Type": "text/html"
                //     },
                //     body: 
                //         `username=${username}&ticket_id=${new_id_string}&full_name=${fullName}&number=${number}&security_code=${securityCode}&expiration_date=${expirationDate}`
                // }

                // const content = `Boarding pass confirmed\\nDear ${username},\\nCongratulations! Your boarding pass for ${ticket.airline}, Flight #${ticket.flight_id}, departing on ${ticket.date} at ${ticket.time}, from ${ticket.from} to ${ticket.to} has been secured. Your seat: ${ticket.seat}.\\nSafe travels!\\n\\nYour boarding pass number: ${ticket.ticket_id}`;

                // const date = new Date();
                // const dateString = date.toISOString().split('T')[0];
                // const timeString = date.toLocaleTimeString('en-US', {
                //     hour12: false,
                //     hour: "numeric",
                //     minute: "numeric"
                // });

                // const requestOptionsNotification = {
                //     method: "POST",
                //     headers: {
                //         "Content-Type": "text/html"
                //     },
                //     body: 
                //         `username=${username}&content=${content}&date=${dateString}&time=${timeString}`
                // }
                
                // fetch("/own", requestOptionsOwn)
                // .then(response => {
                //     return(response.status);
                // })
                // .then(status => {
                //     if (status == 200) {
                //         fetch("/notification", requestOptionsNotification)
                //         .then(response => {
                //             return(response.status);
                //         })
                //         .then(status => {
                //             if (status == 200) {
                //                 alert("You have a new notification!");
                //                 window.location.replace("http://localhost:8001/notifications");
                //             }
                //         })
                //     }
                //     else {
                //         alert("Error");
                //     }
                // })
        }
        function deleteOld(){

        }
        //function exchange
        function exhange() {
            ownOldToNew();
            deleteOld();
            
            }
        // function xu ly khi nguoi dung chon 
        function pick(new_id_string){
            let ticket;
            
            exchange_div.onclick = function(){
                var result = confirm(`${ticket} Ban da chac chan`);
                if(result){
                    exhange();
                }
                else{
                    window.location.reload();
                }
            }
        }
        function renderTickets() {
            const ul = document.getElementById("tickets");
            ul.innerHTML = ""; // xoa cac element da co de them tu dau

            filteredTickets.forEach(ticket => {
                const a = document.createElement("a");
                a.className = "ticket";
                const ticketInfo = document.getElementById("ticket-info");
                if (old_id) { // neu co old_id 
                    a.onclick = function () {
                        new_id_string='';
                        new_id_string=new_id_string+ticket.ticket_id;
                        console.log(ticket.ticket_id);
                        fetch(`/ticket/${new_id_string}`, {
                method: "GET",
            })
            .then(response => {
                return(response.text());
            })
            .then(data => {
                var tickethaha = JSON.parse(data)
                console.log(tickethaha);
            })
                        pick(new_id_string);
                        
                    }
                } else {
                    a.setAttribute("href", `http://localhost:8001/buy/${ticket.ticket_id}`);
                }
                a.textContent = ticket.seat;
                if (ticket.owned == "1") {
                    a.className = "disabled";
                }
                ul.appendChild(a);
            });
        }

        fetch(`/flights/${id}`, {
            method: "GET",
        })
            .then(response => {
                return (response.text());
            })
            .then(data => {
                const flightData = JSON.parse(data)[0];
                document.getElementById("flight").innerText = flightData.flight_id;
                document.getElementById("from").innerText = flightData.from;
                document.getElementById("to").innerText = flightData.to;
                document.getElementById("airline").innerText = flightData.airline;
                document.getElementById("date").innerText = flightData.date;
                document.getElementById("time").innerText = flightData.time;
            })

        fetch(`/tickets/${id}`, {
            method: "GET",
        })
            .then(response => {
                return (response.text());
            })
            .then(data => {
                console.log(data);
                tickets = JSON.parse(data);
                filteredTickets = tickets;
                renderTickets();
            })

        fetch(`/unread/${username}`, {
            method: "GET",
        })
            .then(response => {
                return (response.text());
            })
            .then(data => {
                console.log(data);
                const unread = document.getElementById("unread");
                unread.innerText = JSON.parse(data)[0].count;
            })
    //2. xu ly trang flight cua doi ve 
            
            if(old_id){
                exchange_div.style.display='block';

            }

        

    </script>

</html>