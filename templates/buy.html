<!DOCTYPE html>
<html>
    <body>
        <div id="ticket-info">
            <div class="ticket-info-column">Flight: <span id="flight"></span></div>
            <div class="ticket-info-column">From: <span id="from"></span></div>
            <div class="ticket-info-column">To: <span id="to"></span></div>
            <div class="ticket-info-column">Date: <span id="date"></span></div>
            <div class="ticket-info-column">Time: <span id="time"></span></div>
        </div>
        <div id="user-form">
            <label for="number">Credit Card</label>            
            <input type="text" name="number" id="number">

            <label for="number">Expiration Date</label>    
            <input type="date" name="expiration-date" id="expiration-date">

            <label for="security-code">Security Code</label>    
            <input type="text" name="security-code" id="security-code">

            <label for="full-name">Card Holder Name</label>
            <input type="text" name="full-name" id="full-name">
            <button type="button" onclick="submit()">Submit</button>
        </div>
    </body>
    <script>
        const url = window.location.pathname;
        const id = url.split("/")[2];
        let ticket = null;

        function renderTicket(ticket) {
            const ticketInfo = document.getElementById("ticket-info");
            document.getElementById("flight").innerText = ticket.flight_id;
            document.getElementById("from").innerText = ticket.from;
            document.getElementById("to").innerText = ticket.to;
            document.getElementById("date").innerText = ticket.date;
            document.getElementById("time").innerText = ticket.time;
        }

        fetch(`/ticket/${id}`, {
            method: "GET",
        })
        .then(response => {
            return(response.text());
        })
        .then(data => {
            // console.log(data);
            ticket = JSON.parse(data)[0];
            renderTicket(ticket);
        })

        function submit() {
            const username = localStorage.getItem("username");
            if (username == null) {
                window.location = "http://localhost:8001/login";
                return;
            }
            let number = document.getElementById("number").value;
            let expirationDate = document.getElementById("expiration-date").value;
            let securityCode = document.getElementById("security-code").value;
            let fullName = document.getElementById("full-name").value;
            console.log(`number: ${number}\nexpirationDate: ${expirationDate},\nsecurityCode: ${securityCode}\nfullName: ${fullName}`);
            
            const requestOptionsOwn = {
                method: "POST",
                headers: {
                    "Content-Type": "text/html"
                },
                body: 
                    `username=${username}&ticket_id=${id}&full_name=${fullName}&number=${number}&security_code=${securityCode}&expiration_date=${expirationDate}`
            }

            const content = `Boarding pass confirmed\\nDear ${username},\\nCongratulations! Your boarding pass for ${ticket.airline}, Flight #${ticket.flight_id}, departing on ${ticket.date} at ${ticket.time}, from ${ticket.from} to ${ticket.to} has been secured. Your seat: ${ticket.seat}.\\nSafe travels!\\n\\nYour boarding pass number: ${ticket.ticket_id}`;

            const date = new Date();
            const dateString = date.toISOString().split('T')[0];
            const timeString = date.toLocaleTimeString('en-US', {
                hour12: false,
                hour: "numeric",
                minute: "numeric"
            });

            const requestOptionsNotification = {
                method: "POST",
                headers: {
                    "Content-Type": "text/html"
                },
                body: 
                    `username=${username}&content=${content}&date=${dateString}&time=${timeString}`
            }
            
            fetch("/own", requestOptionsOwn)
            .then(response => {
                return(response.status);
            })
            .then(status => {
                if (status == 200) {
                    fetch("/notification", requestOptionsNotification)
                    .then(response => {
                        return(response.status);
                    })
                    .then(status => {
                        if (status == 200) {
                            alert("You have a new notification!");
                            window.location.replace("http://localhost:8001");
                        }
                    })
                }
                else {
                    alert("Error");
                }
            })
        }
    </script>
</html>